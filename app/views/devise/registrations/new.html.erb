<div class="registration-container">
  <div class="registration-header">
    <h1>Т│ЋС║║сѓбсѓФсѓдсЃ│сЃѕуЎ╗жї▓</h1>
    <p class="subtitle">тїќу▓ДтЊЂжќІуЎ║у«Ауљєсѓисѓ╣сЃєсЃасЂИсѓѕсЂєсЂЊсЂЮ</p>
  </div>

  <div class="card">
    <div class="card-content">
      <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { class: "registration-form" }) do |f| %>
        <%= render "devise/shared/error_messages", resource: resource %>

        <!-- С╝џуцЙТЃЁта▒сѓ╗сѓ»сѓисЃДсЃ│ -->
        <div class="form-section">
          <h3 class="section-title">­ЪЊІ С╝џуцЙТЃЁта▒</h3>
          
          <div class="form-group">
            <%= label_tag "user_company_name", "С╝џуцЙтљЇ", class: "form-label required" %>
            <%= text_field_tag "user[company_name]", "", class: "form-input", placeholder: "СЙІ№╝џТафт╝ЈС╝џуцЙсѓхсЃ│сЃЌсЃФ", required: true %>
          </div>
          
          <div class="form-section-inner">
            <h4 class="subsection-title">С╝џуцЙСйЈТЅђ</h4>
            
            <div class="form-grid">
              <div class="form-group">
                <%= label_tag "user_company_postal_code", "жЃхСЙ┐уЋфтЈи", class: "form-label" %>
                <%= text_field_tag "user[company_postal_code]", "", class: "form-input", id: "postal_code", placeholder: "СЙІ№╝џ100-0001", pattern: "\d{3}-\d{4}", maxlength: "8" %>
                <small class="form-hint">сЃЈсѓцсЃЋсЃ│сѓњтљФсѓЂсЂдтЁЦтіЏсЂЎсѓІсЂеУЄфтІЋсЂДСйЈТЅђсЂїУБют«їсЂЋсѓїсЂЙсЂЎ</small>
                <div id="postal_code_loading" class="loading-indicator" style="display: none;">
                  <span>СйЈТЅђсѓњтЈќтЙЌСИГ...</span>
                </div>
              </div>
              
              <div class="form-group">
                <%= label_tag "user_company_prefecture", "жЃйжЂЊт║юуюї", class: "form-label" %>
                <%= select_tag "user[company_prefecture]", 
                    content_tag(:option, "жЃйжЂЊт║юуюїсѓњжЂИТіъ", value: "", selected: true) + 
                    options_for_select([
                      ['тїЌТхижЂЊ', 'тїЌТхижЂЊ'], ['жЮњТБ«уюї', 'жЮњТБ«уюї'], ['т▓ЕТЅІуюї', 'т▓ЕТЅІуюї'], ['т««тЪјуюї', 'т««тЪјуюї'], ['уДІућ░уюї', 'уДІућ░уюї'],
                      ['т▒▒тйбуюї', 'т▒▒тйбуюї'], ['удЈт│Хуюї', 'удЈт│Хуюї'], ['УїетЪјуюї', 'УїетЪјуюї'], ['ТаЃТюеуюї', 'ТаЃТюеуюї'], ['уЙцждгуюї', 'уЙцждгуюї'],
                      ['тЪ╝ујЅуюї', 'тЪ╝ујЅуюї'], ['тЇЃУЉЅуюї', 'тЇЃУЉЅуюї'], ['ТЮ▒С║гжЃй', 'ТЮ▒С║гжЃй'], ['уЦътЦѕтиЮуюї', 'уЦътЦѕтиЮуюї'], ['Тќ░ТйЪуюї', 'Тќ░ТйЪуюї'],
                      ['т»їт▒▒уюї', 'т»їт▒▒уюї'], ['уЪ│тиЮуюї', 'уЪ│тиЮуюї'], ['удЈС║Ћуюї', 'удЈС║Ћуюї'], ['т▒▒Тбеуюї', 'т▒▒Тбеуюї'], ['жЋижЄјуюї', 'жЋижЄјуюї'],
                      ['т▓љжўюуюї', 'т▓љжўюуюї'], ['жЮЎт▓Ауюї', 'жЮЎт▓Ауюї'], ['ТёЏуЪЦуюї', 'ТёЏуЪЦуюї'], ['СИЅжЄЇуюї', 'СИЅжЄЇуюї'], ['Т╗ІУ│ђуюї', 'Т╗ІУ│ђуюї'],
                      ['С║гжЃйт║ю', 'С║гжЃйт║ю'], ['тцДжўфт║ю', 'тцДжўфт║ю'], ['тЁхт║Фуюї', 'тЁхт║Фуюї'], ['тЦѕУЅ»уюї', 'тЦѕУЅ»уюї'], ['тњїТГїт▒▒уюї', 'тњїТГїт▒▒уюї'],
                      ['ж│ЦтЈќуюї', 'ж│ЦтЈќуюї'], ['т│ХТа╣уюї', 'т│ХТа╣уюї'], ['т▓Ат▒▒уюї', 'т▓Ат▒▒уюї'], ['т║Ѓт│Хуюї', 'т║Ѓт│Хуюї'], ['т▒▒тЈБуюї', 'т▒▒тЈБуюї'],
                      ['тЙ│т│Хуюї', 'тЙ│т│Хуюї'], ['ждЎтиЮуюї', 'ждЎтиЮуюї'], ['ТёЏтфЏуюї', 'ТёЏтфЏуюї'], ['жФўуЪЦуюї', 'жФўуЪЦуюї'], ['удЈт▓Ауюї', 'удЈт▓Ауюї'],
                      ['СйљУ│ђуюї', 'СйљУ│ђуюї'], ['жЋит┤јуюї', 'жЋит┤јуюї'], ['уєіТюгуюї', 'уєіТюгуюї'], ['тцДтѕєуюї', 'тцДтѕєуюї'], ['т««т┤јуюї', 'т««т┤јуюї'],
                      ['ж╣┐тЁљт│Хуюї', 'ж╣┐тЁљт│Хуюї'], ['Т▓ќуИёуюї', 'Т▓ќуИёуюї']
                    ]), 
                    { class: "form-select", id: "prefecture_select" } %>
              </div>
            </div>
            
            <div class="form-group">
              <%= label_tag "user_company_city_address", "тИѓтї║ућ║ТЮЉсЃ╗уЋфтю░", class: "form-label" %>
              <%= text_field_tag "user[company_city_address]", "", class: "form-input", id: "city_address", placeholder: "СЙІ№╝џтЇЃС╗Бућ░тї║тЇЃС╗Бућ░1-1-1" %>
            </div>
            
            <div class="form-group">
              <%= label_tag "user_company_building", "т╗║уЅЕтљЇсЃ╗жЃет▒ІуЋфтЈи", class: "form-label" %>
              <%= text_field_tag "user[company_building]", "", class: "form-input", placeholder: "СЙІ№╝џРЌІРЌІсЃЊсЃФ 5F" %>
              <small class="form-hint">С╗╗ТёЈтЁЦтіЏ</small>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <%= label_tag "user_company_phone", "жЏ╗УЕ▒уЋфтЈи", class: "form-label" %>
              <%= text_field_tag "user[company_phone]", "", class: "form-input", placeholder: "СЙІ№╝џ03-1234-5678" %>
            </div>
            
            <div class="form-group">
              <%= label_tag "user_company_website", "сѓдсѓДсЃќсѓхсѓцсЃѕ", class: "form-label" %>
              <%= url_field_tag "user[company_website]", "", class: "form-input", placeholder: "СЙІ№╝џhttps://example.com" %>
            </div>
          </div>
          
          <div class="form-group">
            <%= label_tag "user_company_employee_count", "тЙЊТЦГтЊАТЋ░", class: "form-label" %>
            <%= number_field_tag "user[company_employee_count]", "", class: "form-input", placeholder: "СЙІ№╝џ50", min: 1 %>
          </div>
        </div>

        <!-- у«АуљєУђЁТЃЁта▒сѓ╗сѓ»сѓисЃДсЃ│ -->
        <div class="form-section">
          <h3 class="section-title">­ЪЉц у«АуљєУђЁсѓбсѓФсѓдсЃ│сЃѕТЃЁта▒</h3>
          
          <div class="form-grid">
            <div class="form-group">
              <%= f.label :name, "сЂітљЇтЅЇ", class: "form-label required" %>
              <%= f.text_field :name, class: "form-input", placeholder: "СЙІ№╝џућ░СИГ тцфжЃј", required: true %>
            </div>
            
            <div class="form-group">
              <%= f.label :email, "сЃАсЃ╝сЃФсѓбсЃЅсЃгсѓ╣", class: "form-label required" %>
              <%= f.email_field :email, class: "form-input", placeholder: "СЙІ№╝џadmin@example.com", autocomplete: "email", required: true %>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <%= f.label :password, "сЃЉсѓ╣сЃ»сЃ╝сЃЅ", class: "form-label required" %>
              <% if @minimum_password_length %>
                <small class="form-hint"><%= @minimum_password_length %>ТќЄтГЌС╗ЦСИісЂДУеГт«џсЂЌсЂдсЂЈсЂасЂЋсЂё</small>
              <% end %>
              <%= f.password_field :password, class: "form-input", placeholder: "т«ЅтЁесЂфсЃЉсѓ╣сЃ»сЃ╝сЃЅсѓњтЁЦтіЏ", autocomplete: "new-password", required: true %>
            </div>

            <div class="form-group">
              <%= f.label :password_confirmation, "сЃЉсѓ╣сЃ»сЃ╝сЃЅуб║УфЇ", class: "form-label required" %>
              <%= f.password_field :password_confirmation, class: "form-input", placeholder: "сЃЉсѓ╣сЃ»сЃ╝сЃЅсѓњтєЇтЁЦтіЏ", autocomplete: "new-password", required: true %>
            </div>
          </div>
        </div>

        <!-- тѕЕућеУдЈу┤ё -->
        <div class="form-section">
          <div class="form-group">
            <label class="checkbox-group">
              <%= check_box_tag "user[terms_accepted]", "1", false, required: true %>
              <span class="checkbox-label">
                <a href="#" target="_blank">тѕЕућеУдЈу┤ё</a>сЂісѓѕсЂ│<a href="#" target="_blank">сЃЌсЃЕсѓцсЃљсѓисЃ╝сЃЮсЃфсѓисЃ╝</a>сЂФтљїТёЈсЂЌсЂЙсЂЎ
              </span>
            </label>
          </div>
        </div>

        <div class="form-actions">
          <%= f.submit "сѓбсѓФсѓдсЃ│сЃѕсѓњСйюТѕљ", class: "btn btn-primary btn-large" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="auth-links">
    <%= render "devise/shared/links" %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const postalCodeInput = document.getElementById('postal_code');
  const prefectureSelect = document.getElementById('prefecture_select');
  const cityAddressInput = document.getElementById('city_address');
  const loadingIndicator = document.getElementById('postal_code_loading');
  
  let timeout;
  
  // жЃхСЙ┐уЋфтЈисЃЋсѓЕсЃ╝сЃъсЃЃсЃѕУБюТГБ№╝ѕсЃЈсѓцсЃЋсЃ│УЄфтІЋТї┐тЁЦ№╝Ѕ
  postalCodeInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, ''); // ТЋ░тГЌсЂ«сЂ┐ТійтЄ║
    if (value.length >= 3) {
      value = value.substr(0, 3) + '-' + value.substr(3, 4);
    }
    e.target.value = value;
    
    // сЃЄсЃљсѓдсЃ│сѓ╣тЄдуљє№╝ѕ500msтЙїсЂФAPIтЉ╝сЂ│тЄ║сЂЌ№╝Ѕ
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      if (value.length === 8 && value.match(/^\d{3}-\d{4}$/)) {
        fetchAddressFromPostalCode(value);
      }
    }, 500);
  });
  
  // жЃхСЙ┐уЋфтЈисЂІсѓЅСйЈТЅђсѓњтЈќтЙЌ
  async function fetchAddressFromPostalCode(postalCode) {
    const cleanPostalCode = postalCode.replace('-', '');
    
    try {
      loadingIndicator.style.display = 'block';
      
      const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${cleanPostalCode}`);
      const data = await response.json();
      
      if (data.status === 200 && data.results && data.results.length > 0) {
        const result = data.results[0];
        
        // жЃйжЂЊт║юуюїсѓњУеГт«џ
        const prefecture = result.address1;
        for (let option of prefectureSelect.options) {
          if (option.value === prefecture) {
            prefectureSelect.value = prefecture;
            break;
          }
        }
        
        // тИѓтї║ућ║ТЮЉсѓњУеГт«џ
        const cityAddress = result.address2 + result.address3;
        cityAddressInput.value = cityAddress;
        
        // ТѕљтіЪсЂ«сЃЋсѓБсЃ╝сЃЅсЃљсЃЃсѓ»
        showFeedback('СйЈТЅђсѓњУЄфтІЋтЁЦтіЏсЂЌсЂЙсЂЌсЂЪ', 'success');
        
        // т╗║уЅЕтљЇсЃЋсѓБсЃ╝сЃФсЃЅсЂФсЃЋсѓЕсЃ╝сѓФсѓ╣
        document.querySelector('input[name="user[company_building]"]').focus();
        
      } else {
        showFeedback('жЃхСЙ┐уЋфтЈисЂїУдІсЂцсЂІсѓісЂЙсЂЏсѓЊсЂДсЂЌсЂЪ', 'error');
      }
    } catch (error) {
      console.error('Address fetch error:', error);
      showFeedback('СйЈТЅђсЂ«тЈќтЙЌсЂФтц▒ТЋЌсЂЌсЂЙсЂЌсЂЪ', 'error');
    } finally {
      loadingIndicator.style.display = 'none';
    }
  }
  
  // сЃЋсѓБсЃ╝сЃЅсЃљсЃЃсѓ»УАеуц║
  function showFeedback(message, type) {
    // ТЌбтГўсЂ«сЃЋсѓБсЃ╝сЃЅсЃљсЃЃсѓ»сѓњтЅіжЎц
    const existingFeedback = document.querySelector('.postal-feedback');
    if (existingFeedback) {
      existingFeedback.remove();
    }
    
    // сЃЋсѓБсЃ╝сЃЅсЃљсЃЃсѓ»УдЂу┤асѓњСйюТѕљ
    const feedback = document.createElement('div');
    feedback.className = `postal-feedback postal-${type}`;
    feedback.textContent = message;
    
    // жЃхСЙ┐уЋфтЈитЁЦтіЏсЃЋсѓБсЃ╝сЃФсЃЅсЂ«тЙїсЂФТї┐тЁЦ
    postalCodeInput.parentNode.insertBefore(feedback, loadingIndicator.nextSibling);
    
    // 3уДњтЙїсЂФУЄфтІЋтЅіжЎц
    setTimeout(() => {
      if (feedback.parentNode) {
        feedback.remove();
      }
    }, 3000);
  }
});
</script>
