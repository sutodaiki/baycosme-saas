<div class="sample-order-page">
  <!-- ãƒ‘ãƒ³ããšãƒŠãƒ“ -->
  <nav class="breadcrumb">
    <% if @sample %>
      <%= link_to sample_path(@sample), class: "breadcrumb-link" do %>
        â† <%= @sample.name %> ã«æˆ»ã‚‹
      <% end %>
    <% else %>
      <%= link_to samples_path, class: "breadcrumb-link" do %>
        â† ã‚µãƒ³ãƒ—ãƒ«ä¸€è¦§ã«æˆ»ã‚‹
      <% end %>
    <% end %>
  </nav>

  <div class="order-container">
    <!-- ã‚µãƒ³ãƒ—ãƒ«æƒ…å ± -->
    <div class="sample-info-card">
      <div class="sample-summary">
        <div class="sample-image-mini">
          <% if @sample&.image_url.present? %>
            <%= image_tag @sample.image_url, alt: @sample.name %>
          <% else %>
            <div class="sample-placeholder-mini">ğŸ§´</div>
          <% end %>
        </div>
        <div class="sample-details">
          <h3 class="sample-name"><%= @sample&.name || 'ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ³ãƒ—ãƒ«' %></h3>
          <p class="sample-type"><%= @sample&.product_type %></p>
          <p class="sample-price"><%= @sample&.display_price || 'ä¾¡æ ¼æœªå®š' %></p>
        </div>
      </div>
    </div>

    <!-- æ³¨æ–‡ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="order-form-card">
      <h1 class="form-title">ğŸ›’ ã‚µãƒ³ãƒ—ãƒ«æ³¨æ–‡</h1>
      <p class="form-description">ä»¥ä¸‹ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ã‚µãƒ³ãƒ—ãƒ«æ³¨æ–‡ã‚’ç¢ºå®šã—ã¦ãã ã•ã„</p>

      <%= form_with model: @sample_order, local: true, class: "order-form" do |f| %>
        <% if @sample %>
          <%= f.hidden_field :sample_id, value: @sample.id %>
        <% end %>

        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <% if @sample_order.errors.any? %>
          <div class="error-messages">
            <h4>å…¥åŠ›ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™:</h4>
            <ul>
              <% @sample_order.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="form-sections">
          <!-- åŸºæœ¬æƒ…å ± -->
          <div class="form-section">
            <h3 class="section-title">åŸºæœ¬æƒ…å ±</h3>
            
            <div class="form-group">
              <%= f.label :quantity, "æ•°é‡", class: "form-label" %>
              <%= f.number_field :quantity, min: 1, max: 10, value: 1, class: "form-control", required: true %>
              <small class="form-help">æœ€å¤§10å€‹ã¾ã§æ³¨æ–‡å¯èƒ½ã§ã™</small>
            </div>

            <div class="form-group">
              <%= f.label :priority, "å„ªå…ˆåº¦", class: "form-label" %>
              <%= f.select :priority, options_from_collection_for_select(SampleOrder::PRIORITIES.map { |name, value| OpenStruct.new(name: name, value: value) }, :value, :name, 'normal'), {}, { class: "form-control" } %>
              <small class="form-help">ç·Šæ€¥ãƒ»é«˜å„ªå…ˆåº¦ã¯è¿½åŠ æ–™é‡‘ãŒã‹ã‹ã‚Šã¾ã™</small>
            </div>
          </div>

          <!-- é…é€å…ˆæƒ…å ± -->
          <div class="form-section">
            <h3 class="section-title">é…é€å…ˆæƒ…å ±</h3>
            
            <div class="form-group">
              <div class="address-option">
                <%= f.radio_button :use_company_address, true, checked: true, id: "use_company_address", class: "address-radio" %>
                <%= f.label :use_company_address, "ä¼šç¤¾ä½æ‰€ã¨åŒã˜", for: "use_company_address", class: "radio-label" %>
              </div>
              <div class="address-option">
                <%= f.radio_button :use_company_address, false, id: "use_different_address", class: "address-radio" %>
                <%= f.label :use_company_address, "åˆ¥ã®ä½æ‰€ã«é…é€", for: "use_different_address", class: "radio-label" %>
              </div>
            </div>
            
            <div id="company-address-display" class="company-address-section">
              <div class="address-display">
                <% if current_user.company %>
                  <div class="address-info">
                    <h4 class="company-name"><%= current_user.company.name %></h4>
                    <% if current_user.company.postal_code %>
                      <p class="address-line">ã€’<%= current_user.company.postal_code %></p>
                    <% end %>
                    <% if current_user.company.address %>
                      <p class="address-line"><%= current_user.company.address %></p>
                    <% end %>
                  </div>
                <% else %>
                  <p class="no-company-info">ä¼šç¤¾æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                <% end %>
              </div>
            </div>
            
            <div id="different-address-form" class="different-address-section" style="display: none;">
              <div class="form-row">
                <div class="form-group">
                  <%= f.label :delivery_postal_code, "éƒµä¾¿ç•ªå·", class: "form-label" %>
                  <%= f.text_field :delivery_postal_code, placeholder: "123-4567", class: "form-control" %>
                </div>
              </div>
              
              <div class="form-row">
                <div class="form-group half-width">
                  <%= f.label :delivery_prefecture, "éƒ½é“åºœçœŒ", class: "form-label" %>
                  <%= f.select :delivery_prefecture, 
                      options_for_select([
                        ['åŒ—æµ·é“', 'åŒ—æµ·é“'], ['é’æ£®çœŒ', 'é’æ£®çœŒ'], ['å²©æ‰‹çœŒ', 'å²©æ‰‹çœŒ'], ['å®®åŸçœŒ', 'å®®åŸçœŒ'],
                        ['ç§‹ç”°çœŒ', 'ç§‹ç”°çœŒ'], ['å±±å½¢çœŒ', 'å±±å½¢çœŒ'], ['ç¦å³¶çœŒ', 'ç¦å³¶çœŒ'], ['èŒ¨åŸçœŒ', 'èŒ¨åŸçœŒ'],
                        ['æ ƒæœ¨çœŒ', 'æ ƒæœ¨çœŒ'], ['ç¾¤é¦¬çœŒ', 'ç¾¤é¦¬çœŒ'], ['åŸ¼ç‰çœŒ', 'åŸ¼ç‰çœŒ'], ['åƒè‘‰çœŒ', 'åƒè‘‰çœŒ'],
                        ['æ±äº¬éƒ½', 'æ±äº¬éƒ½'], ['ç¥å¥ˆå·çœŒ', 'ç¥å¥ˆå·çœŒ'], ['æ–°æ½ŸçœŒ', 'æ–°æ½ŸçœŒ'], ['å¯Œå±±çœŒ', 'å¯Œå±±çœŒ'],
                        ['çŸ³å·çœŒ', 'çŸ³å·çœŒ'], ['ç¦äº•çœŒ', 'ç¦äº•çœŒ'], ['å±±æ¢¨çœŒ', 'å±±æ¢¨çœŒ'], ['é•·é‡çœŒ', 'é•·é‡çœŒ'],
                        ['å²é˜œçœŒ', 'å²é˜œçœŒ'], ['é™å²¡çœŒ', 'é™å²¡çœŒ'], ['æ„›çŸ¥çœŒ', 'æ„›çŸ¥çœŒ'], ['ä¸‰é‡çœŒ', 'ä¸‰é‡çœŒ'],
                        ['æ»‹è³€çœŒ', 'æ»‹è³€çœŒ'], ['äº¬éƒ½åºœ', 'äº¬éƒ½åºœ'], ['å¤§é˜ªåºœ', 'å¤§é˜ªåºœ'], ['å…µåº«çœŒ', 'å…µåº«çœŒ'],
                        ['å¥ˆè‰¯çœŒ', 'å¥ˆè‰¯çœŒ'], ['å’Œæ­Œå±±çœŒ', 'å’Œæ­Œå±±çœŒ'], ['é³¥å–çœŒ', 'é³¥å–çœŒ'], ['å³¶æ ¹çœŒ', 'å³¶æ ¹çœŒ'],
                        ['å²¡å±±çœŒ', 'å²¡å±±çœŒ'], ['åºƒå³¶çœŒ', 'åºƒå³¶çœŒ'], ['å±±å£çœŒ', 'å±±å£çœŒ'], ['å¾³å³¶çœŒ', 'å¾³å³¶çœŒ'],
                        ['é¦™å·çœŒ', 'é¦™å·çœŒ'], ['æ„›åª›çœŒ', 'æ„›åª›çœŒ'], ['é«˜çŸ¥çœŒ', 'é«˜çŸ¥çœŒ'], ['ç¦å²¡çœŒ', 'ç¦å²¡çœŒ'],
                        ['ä½è³€çœŒ', 'ä½è³€çœŒ'], ['é•·å´çœŒ', 'é•·å´çœŒ'], ['ç†Šæœ¬çœŒ', 'ç†Šæœ¬çœŒ'], ['å¤§åˆ†çœŒ', 'å¤§åˆ†çœŒ'],
                        ['å®®å´çœŒ', 'å®®å´çœŒ'], ['é¹¿å…å³¶çœŒ', 'é¹¿å…å³¶çœŒ'], ['æ²–ç¸„çœŒ', 'æ²–ç¸„çœŒ']
                      ], { prompt: 'é¸æŠã—ã¦ãã ã•ã„' }), { class: "form-control" } %>
                </div>
                
                <div class="form-group half-width">
                  <%= f.label :delivery_city, "å¸‚åŒºç”ºæ‘", class: "form-label" %>
                  <%= f.text_field :delivery_city, placeholder: "æ¸‹è°·åŒº", class: "form-control" %>
                </div>
              </div>
              
              <div class="form-group">
                <%= f.label :delivery_street, "ç•ªåœ°ãƒ»ä¸ç›®", class: "form-label" %>
                <%= f.text_field :delivery_street, placeholder: "ç¥å—1-2-3", class: "form-control" %>
              </div>
              
              <div class="form-group">
                <%= f.label :delivery_building, "å»ºç‰©åãƒ»éƒ¨å±‹ç•ªå·", class: "form-label" %>
                <%= f.text_field :delivery_building, placeholder: "â—‹â—‹ãƒ“ãƒ« 101å·å®¤ï¼ˆä»»æ„ï¼‰", class: "form-control" %>
              </div>
            </div>
          </div>

          <!-- å‚™è€ƒ -->
          <div class="form-section">
            <h3 class="section-title">å‚™è€ƒãƒ»è¦æœ›</h3>
            
            <div class="form-group">
              <%= f.label :notes, "å‚™è€ƒãƒ»ç‰¹åˆ¥ãªè¦æœ›", class: "form-label" %>
              <%= f.text_area :notes, rows: 4, class: "form-control", 
                  placeholder: "é…é€ã«é–¢ã™ã‚‹ç‰¹åˆ¥ãªè¦æœ›ã‚„ã€ã‚µãƒ³ãƒ—ãƒ«ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã“ã¨ãªã©ã‚’ãŠæ›¸ããã ã•ã„ï¼ˆä»»æ„ï¼‰" %>
              <small class="form-help">æœ€å¤§1000æ–‡å­—ã¾ã§</small>
            </div>
          </div>

          <!-- æ³¨æ–‡ç¢ºèª -->
          <div class="form-section order-summary">
            <h3 class="section-title">æ³¨æ–‡å†…å®¹ã®ç¢ºèª</h3>
            
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">å•†å“:</span>
                <span class="summary-value"><%= @sample&.name || 'ã‚«ã‚¹ã‚¿ãƒ ã‚µãƒ³ãƒ—ãƒ«' %></span>
              </div>
              <div class="summary-item">
                <span class="summary-label">æ•°é‡:</span>
                <span class="summary-value" id="summary-quantity">1å€‹</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">å„ªå…ˆåº¦:</span>
                <span class="summary-value" id="summary-priority">é€šå¸¸</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">åŸºæœ¬æ–™é‡‘:</span>
                <span class="summary-value" id="summary-price"><%= @sample&.display_price || 'Â¥2,000' %></span>
              </div>
              <div class="summary-item total">
                <span class="summary-label">äºˆæƒ³åˆè¨ˆ:</span>
                <span class="summary-value" id="summary-total">Â¥2,000</span>
              </div>
            </div>
            
            <p class="pricing-note">
              â€» æœ€çµ‚çš„ãªæ–™é‡‘ã¯ç®¡ç†è€…ã«ã‚ˆã‚‹ç¢ºèªå¾Œã«ç¢ºå®šã•ã‚Œã¾ã™<br>
              â€» é€æ–™ã¯åˆ¥é€”ã‹ã‹ã‚Šã¾ã™
            </p>
          </div>
        </div>

        <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
        <div class="form-actions">
          <%= f.submit "ã‚µãƒ³ãƒ—ãƒ«æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹", class: "btn btn-primary btn-lg submit-btn" %>
          <% if @sample %>
            <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", sample_path(@sample), class: "btn btn-outline btn-lg" %>
          <% else %>
            <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", samples_path, class: "btn btn-outline btn-lg" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quantityField = document.querySelector('input[name="sample_order[quantity]"]');
  const priorityField = document.querySelector('select[name="sample_order[priority]"]');
  const basePrice = <%= @sample&.price || 2000 %>;
  
  // Address switching functionality
  const companyAddressRadio = document.getElementById('use_company_address');
  const differentAddressRadio = document.getElementById('use_different_address');
  const companyAddressDisplay = document.getElementById('company-address-display');
  const differentAddressForm = document.getElementById('different-address-form');
  
  function toggleAddressForm() {
    if (differentAddressRadio.checked) {
      companyAddressDisplay.style.display = 'none';
      differentAddressForm.style.display = 'block';
      
      // Make address fields required when using different address
      const addressFields = differentAddressForm.querySelectorAll('input, select');
      addressFields.forEach(field => {
        if (!field.id.includes('building')) { // Building is optional
          field.setAttribute('required', 'required');
        }
      });
    } else {
      companyAddressDisplay.style.display = 'block';
      differentAddressForm.style.display = 'none';
      
      // Remove required attribute when using company address
      const addressFields = differentAddressForm.querySelectorAll('input, select');
      addressFields.forEach(field => {
        field.removeAttribute('required');
      });
    }
  }
  
  companyAddressRadio.addEventListener('change', toggleAddressForm);
  differentAddressRadio.addEventListener('change', toggleAddressForm);
  
  // Initialize address form state
  toggleAddressForm();
  
  function updateSummary() {
    const quantity = parseInt(quantityField.value) || 1;
    const priority = priorityField.value;
    
    // å„ªå…ˆåº¦ã®è¡¨ç¤ºåã‚’æ›´æ–°
    const priorityNames = {
      'normal': 'é€šå¸¸',
      'high': 'é«˜',
      'urgent': 'ç·Šæ€¥'
    };
    
    // å„ªå…ˆåº¦ã®å€ç‡
    const priorityMultipliers = {
      'normal': 1.0,
      'high': 1.5,
      'urgent': 2.0
    };
    
    const total = Math.round(basePrice * quantity * priorityMultipliers[priority]);
    
    document.getElementById('summary-quantity').textContent = quantity + 'å€‹';
    document.getElementById('summary-priority').textContent = priorityNames[priority];
    document.getElementById('summary-total').textContent = 'Â¥' + total.toLocaleString();
  }
  
  quantityField.addEventListener('input', updateSummary);
  priorityField.addEventListener('change', updateSummary);
  
  updateSummary();
});
</script>

<style>
.sample-order-page {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
}

.breadcrumb {
  margin-bottom: 2rem;
}

.breadcrumb-link {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
  transition: color 0.2s ease;
}

.breadcrumb-link:hover {
  color: #5a67d8;
}

.order-container {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.sample-info-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  border: 1px solid #f1f5f9;
}

.sample-summary {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.sample-image-mini {
  width: 80px;
  height: 80px;
  border-radius: 0.75rem;
  overflow: hidden;
  background: #f8fafc;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sample-image-mini img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.sample-placeholder-mini {
  font-size: 2rem;
  opacity: 0.3;
}

.sample-details {
  flex: 1;
}

.sample-name {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1e293b;
  margin: 0 0 0.25rem 0;
}

.sample-type {
  color: #667eea;
  font-size: 0.875rem;
  margin: 0 0 0.25rem 0;
  font-weight: 500;
}

.sample-price {
  color: #059669;
  font-size: 1.125rem;
  font-weight: 700;
  margin: 0;
}

.order-form-card {
  background: white;
  border-radius: 1rem;
  padding: 2rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  border: 1px solid #f1f5f9;
}

.form-title {
  font-size: 2rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0 0 0.5rem 0;
  text-align: center;
}

.form-description {
  text-align: center;
  color: #64748b;
  margin-bottom: 2rem;
}

.error-messages {
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 2rem;
  color: #991b1b;
}

.error-messages h4 {
  margin: 0 0 0.5rem 0;
  font-size: 0.875rem;
  font-weight: 600;
}

.error-messages ul {
  margin: 0;
  padding-left: 1.25rem;
}

.form-sections {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.form-section {
  border: 1px solid #e2e8f0;
  border-radius: 0.75rem;
  padding: 1.5rem;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: #374151;
  margin: 0 0 1.5rem 0;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid #f1f5f9;
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-group:last-child {
  margin-bottom: 0;
}

.form-label {
  display: block;
  font-weight: 500;
  color: #374151;
  margin-bottom: 0.5rem;
}

.form-control {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 0.5rem;
  font-size: 1rem;
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-help {
  display: block;
  font-size: 0.75rem;
  color: #64748b;
  margin-top: 0.25rem;
}

.order-summary {
  background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  border-color: #cbd5e1;
}

.summary-grid {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.summary-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid #e2e8f0;
}

.summary-item:last-child {
  border-bottom: none;
}

.summary-item.total {
  font-weight: 700;
  font-size: 1.125rem;
  border-top: 2px solid #cbd5e1;
  padding-top: 1rem;
  margin-top: 0.5rem;
}

.summary-label {
  color: #64748b;
  font-weight: 500;
}

.summary-value {
  color: #1e293b;
  font-weight: 600;
}

.summary-item.total .summary-value {
  color: #059669;
}

.pricing-note {
  font-size: 0.75rem;
  color: #64748b;
  font-style: italic;
  text-align: center;
  margin: 0;
  line-height: 1.5;
}

.address-option {
  margin-bottom: 1rem;
  padding: 1rem;
  border: 2px solid #e2e8f0;
  border-radius: 0.5rem;
  transition: border-color 0.2s ease;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.address-option:hover {
  border-color: #cbd5e1;
}

.address-option:has(input[type="radio"]:checked) {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.address-radio {
  width: 1.125rem;
  height: 1.125rem;
  cursor: pointer;
}

.radio-label {
  font-weight: 500;
  color: #374151;
  cursor: pointer;
  margin: 0;
}

.company-address-section,
.different-address-section {
  margin-top: 1.5rem;
}

.address-display {
  background: #f0f9ff;
  border-radius: 0.75rem;
  padding: 1.5rem;
  border-left: 4px solid #0ea5e9;
}

.company-name {
  font-size: 1.125rem;
  font-weight: 600;
  color: #0c4a6e;
  margin: 0 0 0.5rem 0;
}

.address-line {
  color: #0c4a6e;
  margin: 0.25rem 0;
  line-height: 1.5;
}

.no-company-info {
  color: #ef4444;
  font-style: italic;
  margin: 0;
}

.form-row {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.form-group.half-width {
  flex: 1;
  margin-bottom: 0;
}

.different-address-section .form-group:last-child {
  margin-bottom: 0;
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 1px solid #e2e8f0;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 1rem 2rem;
  border-radius: 0.75rem;
  font-size: 1rem;
  font-weight: 600;
  text-decoration: none;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-lg {
  padding: 1.25rem 2rem;
  font-size: 1.125rem;
}

.btn-primary {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  color: white;
  border-color: transparent;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(5, 150, 105, 0.3);
}

.btn-outline {
  background: transparent;
  color: #667eea;
  border-color: #667eea;
}

.btn-outline:hover {
  background: #667eea;
  color: white;
}

.submit-btn {
  min-width: 250px;
}

@media (max-width: 768px) {
  .sample-order-page {
    padding: 1rem;
  }
  
  .order-form-card {
    padding: 1.5rem;
  }
  
  .form-section {
    padding: 1rem;
  }
  
  .form-actions {
    flex-direction: column;
    align-items: stretch;
  }
  
  .submit-btn {
    min-width: auto;
  }
  
  .summary-item {
    font-size: 0.875rem;
  }
}
</style>