<div class="page-header">
  <h1 class="page-title">🏭 正式発注管理</h1>
  <p class="page-description">大量発注・本格製造の注文管理システム</p>
</div>

<!-- Stats Dashboard -->
<div class="stats-grid">
  <div class="stat-card total">
    <div class="stat-value"><%= @stats[:total] %></div>
    <div class="stat-label">総発注数</div>
  </div>
  <div class="stat-card pending">
    <div class="stat-value"><%= @stats[:pending_quote] %></div>
    <div class="stat-label">見積もり待ち</div>
  </div>
  <div class="stat-card approval">
    <div class="stat-value"><%= @stats[:pending_approval] %></div>
    <div class="stat-label">承認待ち</div>
  </div>
  <div class="stat-card confirmed">
    <div class="stat-value"><%= @stats[:confirmed] %></div>
    <div class="stat-label">確定済み</div>
  </div>
  <div class="stat-card progress">
    <div class="stat-value"><%= @stats[:in_progress] %></div>
    <div class="stat-label">製造中</div>
  </div>
  <div class="stat-card completed">
    <div class="stat-value"><%= @stats[:completed] %></div>
    <div class="stat-label">完了済み</div>
  </div>
  <div class="stat-card urgent">
    <div class="stat-value"><%= @stats[:urgent] %></div>
    <div class="stat-label">緊急案件</div>
  </div>
  <div class="stat-card revenue">
    <div class="stat-value">¥<%= @stats[:total_revenue].to_s(:delimited) %></div>
    <div class="stat-label">総売上</div>
  </div>
</div>

<!-- Filters Section -->
<div class="filters-section">
  <%= form_with url: admin_formal_orders_path, method: :get, local: true, class: "filters-form" do |f| %>
    <div class="filter-row">
      <div class="filter-group">
        <%= f.text_field :search, placeholder: "企業名、担当者、商品名で検索", value: params[:search], class: "search-input" %>
      </div>
      
      <div class="filter-group">
        <%= f.select :status, options_for_select([['全て', 'all']] + FormalOrder::STATUSES, params[:status]), 
                    { prompt: 'ステータス' }, { class: 'filter-select' } %>
      </div>
      
      <div class="filter-group">
        <%= f.select :priority, options_for_select([['全て', 'all']] + FormalOrder::PRIORITIES, params[:priority]), 
                    { prompt: '優先度' }, { class: 'filter-select' } %>
      </div>
      
      <div class="filter-group">
        <%= f.select :company_id, options_from_collection_for_select([OpenStruct.new(id: 'all', name: '全て')] + @companies, :id, :name, params[:company_id]), 
                    { prompt: '企業' }, { class: 'filter-select' } %>
      </div>
    </div>
    
    <div class="filter-row">
      <div class="filter-group">
        <%= f.date_field :date_from, value: params[:date_from], class: "date-input", placeholder: "開始日" %>
      </div>
      
      <div class="filter-group">
        <%= f.date_field :date_to, value: params[:date_to], class: "date-input", placeholder: "終了日" %>
      </div>
      
      <div class="filter-group">
        <%= f.select :sort, options_for_select([
              ['最新順', ''],
              ['古い順', 'created_asc'],
              ['企業名順', 'company'],
              ['優先度順', 'priority_desc'],
              ['金額順', 'cost_desc'],
              ['数量順', 'quantity_desc']
            ], params[:sort]), 
            { prompt: 'ソート' }, { class: 'filter-select' } %>
      </div>
      
      <div class="filter-actions">
        <%= f.submit "検索", class: "btn btn-primary" %>
        <%= link_to "リセット", admin_formal_orders_path, class: "btn btn-outline" %>
      </div>
    </div>
  <% end %>
</div>

<!-- Orders Table -->
<div class="table-container">
  <% if @formal_orders.any? %>
    <div class="table-responsive">
      <table class="admin-table">
        <thead>
          <tr>
            <th>注文ID</th>
            <th>企業・担当者</th>
            <th>商品情報</th>
            <th>数量</th>
            <th>優先度</th>
            <th>ステータス</th>
            <th>見積金額</th>
            <th>注文日</th>
            <th>予定納期</th>
            <th>アクション</th>
          </tr>
        </thead>
        <tbody>
          <% @formal_orders.each do |order| %>
            <tr class="order-row">
              <td class="id-cell">
                <%= link_to "##{order.id}", admin_formal_order_path(order), class: "order-link" %>
              </td>
              
              <td class="company-cell">
                <div class="company-info">
                  <strong><%= order.company&.name || '未設定' %></strong>
                  <small class="contact-name"><%= order.contact_name %></small>
                </div>
              </td>
              
              <td class="product-cell">
                <div class="product-info">
                  <% if order.sample %>
                    <strong><%= truncate(order.sample.name, length: 20) %></strong>
                    <small class="product-type">サンプル: <%= order.sample.product_type %></small>
                  <% elsif order.cosmetic_formulation %>
                    <strong><%= truncate(order.cosmetic_formulation.product_name, length: 20) %></strong>
                    <small class="product-type">カスタム: <%= order.cosmetic_formulation.product_type_name %></small>
                  <% else %>
                    <strong>カスタム製品</strong>
                    <small class="product-type">詳細未設定</small>
                  <% end %>
                </div>
              </td>
              
              <td class="quantity-cell">
                <strong><%= order.quantity.to_s(:delimited) %></strong>個
              </td>
              
              <td class="priority-cell">
                <span class="priority-badge priority-<%= order.priority %>">
                  <%= order.priority_name %>
                </span>
              </td>
              
              <td class="status-cell">
                <span class="status-badge <%= 
                  case order.status
                  when 'quote_pending' then 'status-warning'
                  when 'quote_approval_pending' then 'status-info'
                  when 'confirmed' then 'status-primary'
                  when 'manufacturing', 'quality_check', 'preparing_shipment' then 'status-progress'
                  when 'shipped', 'delivered' then 'status-success'
                  when 'cancelled' then 'status-danger'
                  else 'status-info'
                  end
                %>">
                  <%= order.status_name %>
                </span>
              </td>
              
              <td class="cost-cell">
                <% if order.total_cost.present? %>
                  <strong>¥<%= order.total_cost.to_s(:delimited) %></strong>
                <% else %>
                  <span class="cost-pending">算出中</span>
                <% end %>
              </td>
              
              <td class="date-cell">
                <%= order.created_at.strftime("%m/%d %H:%M") %>
              </td>
              
              <td class="delivery-cell">
                <% if order.estimated_delivery_date %>
                  <%= order.estimated_delivery_date.strftime("%m/%d") %>
                <% else %>
                  <span class="text-muted">未設定</span>
                <% end %>
              </td>
              
              <td class="action-cell">
                <div class="action-buttons">
                  <%= link_to "詳細", admin_formal_order_path(order), class: "btn btn-sm btn-outline" %>
                  <%= link_to "編集", edit_admin_formal_order_path(order), class: "btn btn-sm btn-primary" %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    
    <!-- Pagination -->
    <div class="pagination-container">
      <%= paginate @formal_orders %>
    </div>
  <% else %>
    <div class="empty-state">
      <div class="empty-icon">🏭</div>
      <h3>正式発注がありません</h3>
      <p class="empty-message">
        <%= params[:search].present? || params[:status].present? || params[:priority].present? ? 
            '検索条件に該当する正式発注が見つかりませんでした。' : 
            'まだ正式発注の依頼がありません。' %>
      </p>
      <% if params.present? %>
        <%= link_to "フィルターをリセット", admin_formal_orders_path, class: "btn btn-outline" %>
      <% end %>
    </div>
  <% end %>
</div>

<style>
.page-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 2rem;
  border-radius: 0.75rem;
  margin-bottom: 2rem;
  text-align: center;
}

.page-title {
  font-size: 1.75rem;
  font-weight: 700;
  margin: 0 0 0.5rem 0;
}

.page-description {
  font-size: 1rem;
  opacity: 0.9;
  margin: 0;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: white;
  padding: 1.5rem;
  border-radius: 0.75rem;
  text-align: center;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  border-left: 4px solid #e2e8f0;
  transition: transform 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.stat-card.total { border-left-color: #64748b; }
.stat-card.pending { border-left-color: #f59e0b; }
.stat-card.approval { border-left-color: #3b82f6; }
.stat-card.confirmed { border-left-color: #8b5cf6; }
.stat-card.progress { border-left-color: #06b6d4; }
.stat-card.completed { border-left-color: #10b981; }
.stat-card.urgent { border-left-color: #ef4444; }
.stat-card.revenue { border-left-color: #059669; }

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 0.25rem;
}

.stat-label {
  font-size: 0.75rem;
  color: #64748b;
  font-weight: 500;
}

.filters-section {
  background: white;
  padding: 1.5rem;
  border-radius: 0.75rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  margin-bottom: 2rem;
}

.filters-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.filter-row {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: end;
}

.filter-group {
  display: flex;
  flex-direction: column;
  min-width: 150px;
  flex: 1;
}

.search-input,
.filter-select,
.date-input {
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  font-size: 0.875rem;
}

.search-input {
  min-width: 250px;
}

.filter-actions {
  display: flex;
  gap: 0.5rem;
  margin-left: auto;
}

.table-container {
  background: white;
  border-radius: 0.75rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

.table-responsive {
  overflow-x: auto;
}

.admin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.admin-table th {
  background: #f8fafc;
  padding: 0.75rem;
  text-align: left;
  font-weight: 600;
  color: #374151;
  border-bottom: 1px solid #e5e7eb;
  white-space: nowrap;
}

.admin-table td {
  padding: 0.75rem;
  border-bottom: 1px solid #f3f4f6;
  vertical-align: top;
}

.order-row:hover {
  background: #f9fafb;
}

.id-cell {
  font-family: monospace;
  font-size: 0.8rem;
  min-width: 80px;
}

.order-link {
  color: #3b82f6;
  text-decoration: none;
  font-weight: 600;
}

.order-link:hover {
  text-decoration: underline;
}

.company-cell {
  min-width: 150px;
}

.company-info strong {
  display: block;
  color: #1f2937;
  margin-bottom: 0.25rem;
}

.contact-name {
  color: #6b7280;
  font-size: 0.75rem;
}

.product-cell {
  min-width: 180px;
}

.product-info strong {
  display: block;
  color: #1f2937;
  margin-bottom: 0.25rem;
}

.product-type {
  color: #6b7280;
  font-size: 0.75rem;
}

.quantity-cell {
  text-align: right;
  font-family: monospace;
  min-width: 80px;
}

.priority-cell,
.status-cell {
  min-width: 100px;
}

.priority-badge,
.status-badge {
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  white-space: nowrap;
}

.priority-normal {
  background-color: #f3f4f6;
  color: #374151;
}

.priority-high {
  background-color: #fef3c7;
  color: #92400e;
}

.priority-urgent {
  background-color: #fee2e2;
  color: #991b1b;
  font-weight: 600;
}

.status-warning {
  background-color: #fef3c7;
  color: #92400e;
}

.status-info {
  background-color: #dbeafe;
  color: #1e40af;
}

.status-primary {
  background-color: #e0e7ff;
  color: #5b21b6;
}

.status-progress {
  background-color: #e0f2fe;
  color: #0369a1;
}

.status-success {
  background-color: #dcfce7;
  color: #166534;
}

.status-danger {
  background-color: #fee2e2;
  color: #991b1b;
}

.cost-cell {
  text-align: right;
  font-family: monospace;
  min-width: 100px;
}

.cost-pending {
  color: #f59e0b;
  font-style: italic;
  font-size: 0.75rem;
}

.date-cell,
.delivery-cell {
  font-family: monospace;
  font-size: 0.75rem;
  color: #6b7280;
  min-width: 80px;
}

.action-cell {
  min-width: 140px;
}

.action-buttons {
  display: flex;
  gap: 0.25rem;
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  border: 1px solid transparent;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-sm {
  padding: 0.25rem 0.75rem;
  font-size: 0.75rem;
}

.btn-primary {
  background-color: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.btn-primary:hover {
  background-color: #2563eb;
  border-color: #2563eb;
}

.btn-outline {
  background-color: transparent;
  color: #6b7280;
  border-color: #d1d5db;
}

.btn-outline:hover {
  background-color: #f9fafb;
  color: #374151;
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #6b7280;
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state h3 {
  color: #374151;
  margin: 0 0 0.5rem 0;
}

.empty-message {
  margin: 0 0 1.5rem 0;
}

.pagination-container {
  padding: 1rem;
  display: flex;
  justify-content: center;
  border-top: 1px solid #f3f4f6;
}

.text-muted {
  color: #9ca3af;
  font-size: 0.75rem;
}

@media (max-width: 1024px) {
  .stats-grid {
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
  
  .filter-row {
    flex-direction: column;
    align-items: stretch;
  }
  
  .filter-actions {
    margin-left: 0;
    justify-content: center;
  }
}

@media (max-width: 768px) {
  .admin-table {
    font-size: 0.75rem;
  }
  
  .admin-table th,
  .admin-table td {
    padding: 0.5rem;
  }
  
  .action-buttons {
    flex-direction: column;
  }
}
</style>